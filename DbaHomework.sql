DROP TABLE ALERTS;
DROP TABLE ENVIRONMENTALDATA;
DROP TABLE ACTIVITIES;
DROP TABLE CAREGIVERS;
DROP TABLE DOCTORS;
DROP TABLE LOCATIONS;
DROP TABLE DEVICES;
DROP TABLE USERS;

create table USERS (
user_id NUMBER GENERATED BY DEFAULT ON NULL as IDENTITY(START with 1 INCREMENT by 1),
user_name VARCHAR(30) NOT NULL,
email VARCHAR(50) NOT NULL,
phone VARCHAR(25) NOT NULL,
age NUMBER NOT NULL,
PRIMARY KEY(user_name)
);

create table CAREGIVERS (
caregiver_name VARCHAR(40) NOT NULL,
fk_user_name VARCHAR(40)UNIQUE NOT NULL,
FOREIGN KEY (fk_user_name) REFERENCES USERS(user_name)
);

create table DOCTORS (
doctor_name VARCHAR(40) NOT NULL,
fk_user_name VARCHAR(40) UNIQUE NOT NULL,
FOREIGN KEY (fk_user_name) REFERENCES USERS(user_name)
);
create table DEVICES (
device_id NUMBER GENERATED BY DEFAULT ON NULL as IDENTITY(START WITH 1 INCREMENT BY 1),
MAC_Device VARCHAR(40) NOT NULL,
Device_Type VARCHAR(40) NOT NULL,
fk_user_name VARCHAR(30) NOT NULL,
PRIMARY KEY(device_id),
FOREIGN KEY(fk_user_name) REFERENCES USERS(user_name)
);

create table LOCATIONS (
location VARCHAR2(40) NOT NULL,
start_time TIMESTAMP NOT NULL,
end_time TIMESTAMP NOT NULL,
fk_user_name VARCHAR(30) NOT NULL,
fk_device_id NUMBER NOT NULL,
FOREIGN KEY (fk_user_name) REFERENCES USERS (user_name),
FOREIGN KEY (fk_device_id) REFERENCES DEVICES (device_id)
);

create  table ACTIVITIES (
activity VARCHAR2(40) NOT NULL,
activity_type VARCHAR2(40) NOT NULL,
start_time TIMESTAMP NOT NULL,
end_time TIMESTAMP NOT NULL,
fk_user_name VARCHAR2(40) NOT NULL,
FOREIGN KEY (fk_user_name) REFERENCES USERS (user_name)
);

create table ENVIRONMENTALDATA (
type_of_measurement VARCHAR2(20) DEFAULT 'HearthRate',
measurement_value NUMBER NOT NULL,
unit_of_measurement VARCHAR2(20) DEFAULT 'BPM',
location VARCHAR2(40) NOT NULL,
exceeded_normal_value VARCHAR2(5) NOT NULL,
measurement_source VARCHAR(40) NOT NULL,
measurement_time TIMESTAMP NOT NULL,
fk_user_name VARCHAR(40) NOT NULL,
FOREIGN KEY(fk_user_name) REFERENCES USERS(user_name)
);

create table ALERTS (
alert_type VARCHAR2(40) NOT NULL,
alert_text VARCHAR2(40) NOT NULL,
alert_source VARCHAR2(40) NOT NULL,
alert_destination  VARCHAR2(40) NOT NULL,
alert_time TIMESTAMP NOT NULL,
fk_user_name VARCHAR2(40) NOT NULL,
FOREIGN KEY (fk_user_name) REFERENCES USERS(user_name)
);

INSERT INTO USERS (user_name, email, phone,age)  VALUES('Catalin Stoicescu', 'stoicescu.catalinn97@gmail.com', '0732416473', 23);
INSERT INTO USERS (user_name, email, phone,age)  VALUES('Bogdan Sava', 'bogdan.sava@yahoo.com', '0743214563', 21);
INSERT INTO USERS (user_name, email, phone,age)  VALUES('Seceleanu Andrei', 'andrei.seceleanu@gmail.com', '0743254253', 26);
INSERT INTO USERS (user_name, email, phone,age)  VALUES('Dragos Serban', 'dragos.andrei@yahoo.com', '0746432563', 22);

INSERT INTO DEVICES (MAC_Device, Device_Type, fk_user_name) VALUES ('96-48-95-A8-92-E7', 'Iphone 11', 'Catalin Stoicescu');
INSERT INTO DEVICES (MAC_Device, Device_Type, fk_user_name) VALUES ('0F-F8-FF-90-B3-BA', 'SmartWatch', 'Bogdan Sava');
INSERT INTO DEVICES (MAC_Device, Device_Type, fk_user_name) VALUES ('71-5C-EC-AF-4A-54', 'Hearth Rate Monitor', 'Seceleanu Andrei');
INSERT INTO DEVICES (MAC_Device, Device_Type, fk_user_name) VALUES ('F9-33-D0-74-A4-CD', 'SmartBand', 'Dragos Serban');



INSERT INTO LOCATIONS VALUES(
'Kitchen',
TO_TIMESTAMP('17.12.2020:14:20:10', 'DD.MM.YYYY:HH24:MI:SS'), 
TO_TIMESTAMP('17.12.2020:14:40:10', 'DD.MM.YYYY:HH24:MI:SS'),
'Catalin Stoicescu', '1');

INSERT INTO LOCATIONS VALUES(
'Living',
TO_TIMESTAMP('17.12.2020:14:40:10', 'DD.MM.YYYY:HH24:MI:SS'), 
TO_TIMESTAMP('17.12.2020:15:50:50', 'DD.MM.YYYY:HH24:MI:SS'),
'Catalin Stoicescu', '1');

INSERT INTO LOCATIONS VALUES(
'Balcony',
TO_TIMESTAMP('17.12.2020:15:50:50', 'DD.MM.YYYY:HH24:MI:SS'), 
TO_TIMESTAMP('17.12.2020:16:10:10', 'DD.MM.YYYY:HH24:MI:SS'),
'Catalin Stoicescu', '1');



INSERT INTO LOCATIONS VALUES(
'Dormroom',
TO_TIMESTAMP('17.12.2020:10:10:40', 'DD.MM.YYYY:HH24:MI:SS'), 
TO_TIMESTAMP('17.12.2020:11:11:50', 'DD.MM.YYYY:HH24:MI:SS'),
'Bogdan Sava', '2');

INSERT INTO LOCATIONS VALUES(
'Living',
TO_TIMESTAMP('17.12.2020:11:11:50', 'DD.MM.YYYY:HH24:MI:SS'), 
TO_TIMESTAMP('17.12.2020:12:50:50', 'DD.MM.YYYY:HH24:MI:SS'),
'Bogdan Sava', '2');

INSERT INTO LOCATIONS VALUES(
'Balcony',
TO_TIMESTAMP('17.12.2020:12:50:50', 'DD.MM.YYYY:HH24:MI:SS'), 
TO_TIMESTAMP('17.12.2020:13:40:40', 'DD.MM.YYYY:HH24:MI:SS'),
'Bogdan Sava', '2');


INSERT INTO LOCATIONS VALUES(
'Bath',
TO_TIMESTAMP('17.12.2020:11:20:40', 'DD.MM.YYYY:HH24:MI:SS'), 
TO_TIMESTAMP('17.12.2020:12:00:30', 'DD.MM.YYYY:HH24:MI:SS'),
'Seceleanu Andrei', '3');

INSERT INTO LOCATIONS VALUES(
'Kitchen',
TO_TIMESTAMP('17.12.2020:12:00:30', 'DD.MM.YYYY:HH24:MI:SS'), 
TO_TIMESTAMP('17.12.2020:13:10:50', 'DD.MM.YYYY:HH24:MI:SS'),
'Seceleanu Andrei', '3');

INSERT INTO LOCATIONS VALUES(
'Balcony',
TO_TIMESTAMP('17.12.2020:13:10:50', 'DD.MM.YYYY:HH24:MI:SS'), 
TO_TIMESTAMP('17.12.2020:13:30:10', 'DD.MM.YYYY:HH24:MI:SS'),
'Seceleanu Andrei', '3');


INSERT INTO LOCATIONS VALUES(
'Dormroom',
TO_TIMESTAMP('17.12.2020:09:10:10', 'DD.MM.YYYY:HH24:MI:SS'), 
TO_TIMESTAMP('17.12.2020:09:40:20', 'DD.MM.YYYY:HH24:MI:SS'),
'Dragos Serban', '4');

INSERT INTO LOCATIONS VALUES(
'Living',
TO_TIMESTAMP('17.12.2020:09:40:20', 'DD.MM.YYYY:HH24:MI:SS'), 
TO_TIMESTAMP('17.12.2020:10:50:50', 'DD.MM.YYYY:HH24:MI:SS'),
'Dragos Serban', '4');

INSERT INTO LOCATIONS VALUES(
'Balcony',
TO_TIMESTAMP('17.12.2020:10:50:50', 'DD.MM.YYYY:HH24:MI:SS'), 
TO_TIMESTAMP('17.12.2020:11:54:10', 'DD.MM.YYYY:HH24:MI:SS'),
'Dragos Serban', '4');

INSERT INTO DOCTORS VALUES(
'Dr. Cosmin Nicolae','Catalin Stoicescu'
);

INSERT INTO DOCTORS VALUES(
'Dr. Dragoslav Theodorescu','Bogdan Sava'
);

INSERT INTO DOCTORS VALUES(
'Dr. Simu Matei','Seceleanu Andrei'
);

INSERT INTO DOCTORS VALUES(
'Dr. Laurensiu Petrescu','Dragos Serban'
);

INSERT INTO CAREGIVERS VALUES( 
'Flavius Ilionescu', 'Catalin Stoicescu'
);

INSERT INTO CAREGIVERS VALUES(
'Tavian Dobre', 'Bogdan Sava'
);

INSERT INTO CAREGIVERS VALUES(
'Haralamb Suciu', 'Seceleanu Andrei'
);

INSERT INTO CAREGIVERS VALUES(
'Jean Troester', 'Dragos Serban'
);

INSERT INTO ACTIVITIES VALUES(
'Eating', 'Physical', TO_TIMESTAMP('17.12.2020:14:20:20', 'DD.MM.YYYY:HH24:MI:SS'), TO_TIMESTAMP('17.12.2020:14:29:20', 'DD.MM.YYYY:HH24:MI:SS'), 'Catalin Stoicescu'
);
INSERT INTO ACTIVITIES VALUES(
'Washing Dishes', 'Physical', TO_TIMESTAMP('17.12.2020:14:31:25', 'DD.MM.YYYY:HH24:MI:SS'), TO_TIMESTAMP('17.12.2020:14:37:15', 'DD.MM.YYYY:HH24:MI:SS'), 'Catalin Stoicescu'
);
INSERT INTO ACTIVITIES VALUES(
'Drink Water', 'Physical', TO_TIMESTAMP('17.12.2020:14:38:25', 'DD.MM.YYYY:HH24:MI:SS'), TO_TIMESTAMP('17.12.2020:14:39:15', 'DD.MM.YYYY:HH24:MI:SS'), 'Catalin Stoicescu'
);
INSERT INTO ACTIVITIES VALUES(
'Watch TV', 'Mental', TO_TIMESTAMP('17.12.2020:14:40:25', 'DD.MM.YYYY:HH24:MI:SS'), TO_TIMESTAMP('17.12.2020:15:07:35', 'DD.MM.YYYY:HH24:MI:SS'), 'Catalin Stoicescu'
);
INSERT INTO ACTIVITIES VALUES(
'Afternoon Nap', 'Mental', TO_TIMESTAMP('17.12.2020:15:10:21', 'DD.MM.YYYY:HH24:MI:SS'), TO_TIMESTAMP('17.12.2020:15:47:39', 'DD.MM.YYYY:HH24:MI:SS'), 'Catalin Stoicescu'
);
INSERT INTO ACTIVITIES VALUES(
'Read a Book', 'Mental', TO_TIMESTAMP('17.12.2020:15:52:50', 'DD.MM.YYYY:HH24:MI:SS'), TO_TIMESTAMP('17.12.2020:16:02:12', 'DD.MM.YYYY:HH24:MI:SS'), 'Catalin Stoicescu'
);

INSERT INTO ACTIVITIES VALUES(
'Get out of bed', 'Physical', TO_TIMESTAMP('17.12.2020:10:12:20', 'DD.MM.YYYY:HH24:MI:SS'), TO_TIMESTAMP('17.12.2020:11:02:11', 'DD.MM.YYYY:HH24:MI:SS'), 'Bogdan Sava'
);

INSERT INTO ACTIVITIES VALUES(
'Play Games on Tv', 'Mental', TO_TIMESTAMP('17.12.2020:11:15:51', 'DD.MM.YYYY:HH24:MI:SS'), TO_TIMESTAMP('17.12.2020:12:41:12', 'DD.MM.YYYY:HH24:MI:SS'), 'Bogdan Sava'
);

INSERT INTO ACTIVITIES VALUES(
'Smoke Cigarettes', 'Physical', TO_TIMESTAMP('17.12.2020:12:55:51', 'DD.MM.YYYY:HH24:MI:SS'), TO_TIMESTAMP('17.12.2020:13:01:12', 'DD.MM.YYYY:HH24:MI:SS'), 'Bogdan Sava'
);

INSERT INTO ACTIVITIES VALUES(
'Wash Face', 'Physical', TO_TIMESTAMP('17.12.2020:11:25:36', 'DD.MM.YYYY:HH24:MI:SS'), TO_TIMESTAMP('17.12.2020:11:55:25', 'DD.MM.YYYY:HH24:MI:SS'), 'Seceleanu Andrei'
);


INSERT INTO ACTIVITIES VALUES(
'Eating', 'Physical', TO_TIMESTAMP('17.12.2020:12:27:31', 'DD.MM.YYYY:HH24:MI:SS'), TO_TIMESTAMP('17.12.2020:13:05:21', 'DD.MM.YYYY:HH24:MI:SS'), 'Seceleanu Andrei'
);

INSERT INTO ACTIVITIES VALUES(
'Nap', 'Mental', TO_TIMESTAMP('17.12.2020:13:12:42', 'DD.MM.YYYY:HH24:MI:SS'), TO_TIMESTAMP('17.12.2020:13:20:33', 'DD.MM.YYYY:HH24:MI:SS'), 'Seceleanu Andrei'
);


INSERT INTO ACTIVITIES VALUES(
'Making bed', 'Physical', TO_TIMESTAMP('17.12.2020:09:12:13', 'DD.MM.YYYY:HH24:MI:SS'), TO_TIMESTAMP('17.12.2020:09:39:12', 'DD.MM.YYYY:HH24:MI:SS'), 'Dragos Serban'
);

INSERT INTO ACTIVITIES VALUES(
'Moving Furniture', 'Physical', TO_TIMESTAMP('17.12.2020:09:52:12', 'DD.MM.YYYY:HH24:MI:SS'), TO_TIMESTAMP('17.12.2020:10:32:29', 'DD.MM.YYYY:HH24:MI:SS'), 'Dragos Serban'
);

INSERT INTO ACTIVITIES VALUES(
'Meditating', 'Mental', TO_TIMESTAMP('17.12.2020:10:52:42', 'DD.MM.YYYY:HH24:MI:SS'), TO_TIMESTAMP('17.12.2020:11:50:48', 'DD.MM.YYYY:HH24:MI:SS'), 'Dragos Serban'
);

INSERT INTO ENVIRONMENTALDATA (measurement_value, location, exceeded_normal_value, measurement_source, measurement_time, fk_user_name) 
VALUES (70,'Kitchen', 'NO', 'Iphone', TO_TIMESTAMP('17.12.2020:14:23:17', 'DD.MM.YYYY:HH24:MI:SS'), 'Catalin Stoicescu');

INSERT INTO ENVIRONMENTALDATA (measurement_value, location, exceeded_normal_value, measurement_source, measurement_time, fk_user_name) 
VALUES (123,'Living', 'YES', 'Iphone', TO_TIMESTAMP('17.12.2020:14:45:24', 'DD.MM.YYYY:HH24:MI:SS'), 'Catalin Stoicescu');

INSERT INTO ENVIRONMENTALDATA (measurement_value, location, exceeded_normal_value, measurement_source, measurement_time, fk_user_name) 
VALUES (103,'Balcony', 'YES', 'Iphone', TO_TIMESTAMP('17.12.2020:15:55:47', 'DD.MM.YYYY:HH24:MI:SS'), 'Catalin Stoicescu');

INSERT INTO ENVIRONMENTALDATA (measurement_value, location, exceeded_normal_value, measurement_source, measurement_time, fk_user_name) 
VALUES (73,'Balcony', 'NO', 'Smartwatch', TO_TIMESTAMP('17.12.2020:11:45:37', 'DD.MM.YYYY:HH24:MI:SS'), 'Bogdan Sava');

INSERT INTO ENVIRONMENTALDATA (measurement_value, location, exceeded_normal_value, measurement_source, measurement_time, fk_user_name) 
VALUES (133,'Living', 'YES', 'Smartwatch', TO_TIMESTAMP('17.12.2020:12:35:42', 'DD.MM.YYYY:HH24:MI:SS'), 'Bogdan Sava');

INSERT INTO ENVIRONMENTALDATA (measurement_value, location, exceeded_normal_value, measurement_source, measurement_time, fk_user_name) 
VALUES (93,'Dormroom', 'NO', 'Hearh Rate Monitor', TO_TIMESTAMP('17.12.2020:14:19:34', 'DD.MM.YYYY:HH24:MI:SS'), 'Seceleanu Andrei');

INSERT INTO ENVIRONMENTALDATA (measurement_value, location, exceeded_normal_value, measurement_source, measurement_time, fk_user_name) 
VALUES (67,'Bathroom', 'NO', 'SmartBand', TO_TIMESTAMP('17.12.2020:10:28:32', 'DD.MM.YYYY:HH24:MI:SS'), 'Dragos Serban');

INSERT INTO ENVIRONMENTALDATA (measurement_value, location, exceeded_normal_value, measurement_source, measurement_time, fk_user_name) 
VALUES (71,'Bathroom', 'YES', 'SmartBand', TO_TIMESTAMP('17.12.2020:12:52:42', 'DD.MM.YYYY:HH24:MI:SS'), 'Dragos Serban');

INSERT INTO ALERTS VALUES ('ORANGE', 'Emergency! User hearthrate is rapid!', 'Iphone', 'Dr. Cosmin Nicolae', TO_TIMESTAMP('17.12.2020:14:19:34', 'DD.MM.YYYY:HH24:MI:SS'), 'Catalin Stoicescu');
INSERT INTO ALERTS VALUES ('YELLOW', 'Emergency! User hearthrate is rising!', 'Iphone', 'Dr. Cosmin Nicolae', TO_TIMESTAMP('17.12.2020:14:10:13', 'DD.MM.YYYY:HH24:MI:SS'), 'Catalin Stoicescu');
INSERT INTO ALERTS VALUES ('RED', 'Emergency! User hearthrate is very rapid!', 'Smartwatch', 'Dr. Cosmin Nicolae', TO_TIMESTAMP('17.12.2020:12:11:47', 'DD.MM.YYYY:HH24:MI:SS'), 'Bogdan Sava');



SELECT USERS.user_id, USERS.user_name as Name, USERS.email, USERS.phone, USERS.age, DEVICES.Device_type as "Associated Device"
FROM USERS, DEVICES
where USERS.user_name = DEVICES.fk_user_name;

SELECT USERS.user_name, DOCTORS.doctor_name, CAREGIVERS.caregiver_name 
FROM USERS, DOCTORS, CAREGIVERS
where users.user_name = doctors.fk_user_name AND users.user_name = caregivers.fk_user_name;

SELECT USERS.user_name as Name, LOCATIONS.location as Location, LOCATIONS.start_time as "Start Time", LOCATIONS.end_time as "End Time"
FROM USERS, LOCATIONS
where USERS.user_name = LOCATIONS.fk_user_name;

SELECT USERS.user_name as Name, LOCATIONS.location as Location, 
(EXTRACT(HOUR FROM(LOCATIONS.end_time))*3600+EXTRACT(MINUTE FROM(LOCATIONS.end_time))*60-EXTRACT(HOUR FROM(LOCATIONS.start_time))*3600-EXTRACT(MINUTE FROM(LOCATIONS.start_time))*60)*100 / 
(SELECT EXTRACT(HOUR FROM (MAX(LOCATIONS.end_time)))*3600+EXTRACT(MINUTE FROM (MAX(LOCATIONS.end_time)))*60-EXTRACT(HOUR FROM (MIN(LOCATIONS.start_time)))*3600-EXTRACT(MINUTE FROM (MIN(LOCATIONS.start_time)))*60 FROM LOCATIONS where fk_user_name=USERS.user_name) as "Percentage spent at location(%)"
FROM USERS , LOCATIONS
where USERS.user_name = LOCATIONS.fk_user_name;

SELECT USERS.user_name, ACTIVITIES.activity as Activity, ACTIVITIES.activity_type as "Activity type", ACTIVITIES.start_time as "Start time", ACTIVITIES.end_time as "End Time"
FROM USERS, ACTIVITIES
where users.user_name = activities.fk_user_name;


SELECT USERS.user_name as Name, ACTIVITIES.activity as "Activity", ACTIVITIES.activity_type as "Activity type", 
(EXTRACT(HOUR FROM(ACTIVITIES.end_time))*3600+EXTRACT(MINUTE FROM(ACTIVITIES.end_time))*60-EXTRACT(HOUR FROM(ACTIVITIES.start_time))*3600-EXTRACT(MINUTE FROM(ACTIVITIES.start_time))*60)*100 / 
(SELECT EXTRACT(HOUR FROM (MAX(ACTIVITIES.end_time)))*3600+EXTRACT(MINUTE FROM (MAX(ACTIVITIES.end_time)))*60-EXTRACT(HOUR FROM (MIN(ACTIVITIES.start_time)))*3600-EXTRACT(MINUTE FROM (MIN(ACTIVITIES.start_time)))*60 FROM ACTIVITIES where fk_user_name=USERS.user_name) as "Activity percentage(%)"
FROM USERS , ACTIVITIES
where USERS.user_name = ACTIVITIES.fk_user_name;

SELECT DEVICES.MAC_device as "MAC Device", DEVICES.device_type as "Device type", USERS.user_name as "Associated user", LOCATIONS.location as "Location", LOCATIONS.start_time as "Start time", LOCATIONS.end_time as "End time"
FROM USERS, LOCATIONS, DEVICES
where users.user_name = devices.fk_user_name AND devices.device_id = locations.fk_device_id;

SELECT USERS.user_name as Name, ENVIRONMENTALDATA.type_of_measurement as "Type of measurement", ENVIRONMENTALDATA.measurement_value as "Value", ENVIRONMENTALDATA.unit_of_measurement as "Unit of measurement", ENVIRONMENTALDATA.EXCEEDED_NORMAL_VALUE AS "Exceeded normal value", ENVIRONMENTALDATA.measurement_source as "Measurement Source", ENVIRONMENTALDATA.measurement_time as "Measurement time"
FROM USERS, ENVIRONMENTALDATA
where users.user_name = environmentaldata.fk_user_name;

SELECT USERS.user_name as Name, COUNT(ACTIVITIES.activity) as "Most Total activities"
FROM USERS
INNER JOIN activities on users.user_name = activities.fk_user_name
GROUP BY users.user_name
ORDER BY "Most Total activities" DESC
 OFFSET 0 ROWS
  FETCH NEXT 1 ROWS ONLY;
  

  SELECT  USERS.user_name as Name, COUNT(ACTIVITIES.activity) as "Least Total activities"
FROM USERS
INNER JOIN activities on users.user_name = activities.fk_user_name
GROUP BY users.user_name
ORDER BY "Least Total activities" ASC
 OFFSET 0 ROWS
  FETCH NEXT 1 ROWS ONLY;

SELECT USERS.user_name as Name, ALERTS.alert_type as "Alert type", ALERTS.alert_text as "Alert Text", ALERTS.alert_source as "Alert Source", ALERTS.alert_destination as "Alert Destination", ALERTS.alert_time as "Alert Time"
FROM USERS, ALERTS
where users.user_name = alerts.fk_user_name;

SELECT  USERS.user_name as Name, EXTRACT(MONTH FROM(ALERTS.alert_time)) as "Month with most alerts COUNT(ALERTS.alert_type) as "Most Alerts"
FROM USERS
INNER JOIN alerts on users.user_name = alerts.fk_user_name
GROUP BY users.user_name
ORDER BY "Most Alerts" DESC
 OFFSET 0 ROWS
  FETCH NEXT 1 ROWS ONLY;